name: CI - Integration

on:
  workflow_dispatch:
  workflow_call:

jobs:
  integration:
    name: Build · Compose · Cypress
    runs-on: ubuntu-latest

    env:
      COMPOSE_FILE: docker/docker-compose.integration.yml
      CYPRESS_BASE_URL: http://app.localtest.me:4173
      CYPRESS_GATEWAY_URL: http://api.localtest.me:8090
      CYPRESS_KEYCLOAK_URL: http://auth.localtest.me:8080/realms/obertibussoserviciosinmobiliarios-integration
      CYPRESS_API_URL: http://api.localtest.me:8090/api
      INTEGRATION_DB_URL: ${{ secrets.DB_SQL_URL_QA }}
      INTEGRATION_DB_USERNAME: ${{ secrets.DB_SQL_USERNAME }}
      INTEGRATION_DB_PASSWORD: ${{ secrets.DB_SQL_PASSWORD }}
      ML_API_URL: ${{ secrets.ML_API_URL_QA }}
      AZURE_BLOB_CONNECTION_STRING: ${{ secrets.AZURE_BLOB_CONNECTION_STRING }}
      EMAIL_USERNAME: ${{ secrets.EMAIL_USERNAME }}
      EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Map integration domains
        run: |
          for host in auth.localtest.me api.localtest.me app.localtest.me eureka.localtest.me properties.localtest.me users.localtest.me ml.localtest.me; do
            if ! grep -q "$host" /etc/hosts; then
              echo "127.0.0.1 $host" | sudo tee -a /etc/hosts > /dev/null
            fi
          done

      - name: Debug email secrets presence
        run: |
          if [ -z "${EMAIL_USERNAME}" ]; then
            echo "::warning::EMAIL_USERNAME is empty"
          else
            echo "EMAIL_USERNAME length: ${#EMAIL_USERNAME}"
          fi
          if [ -z "${EMAIL_PASSWORD}" ]; then
            echo "::warning::EMAIL_PASSWORD is empty"
          else
            echo "EMAIL_PASSWORD length: ${#EMAIL_PASSWORD}"
          fi

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install Cypress dependencies
        working-directory: frontend
        run: npm ci

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build integration images
        run: docker compose -f $COMPOSE_FILE build

      - name: Launch integration stack
        run: docker compose -f $COMPOSE_FILE up -d

      - name: Wait for services readiness
        run: |
          services=(
            "gateway|http://api.localtest.me:8090/actuator/health"
            "ms-properties|http://properties.localtest.me:8083/actuator/health"
            "ms-users|http://users.localtest.me:8081/actuator/health"
            "eureka|http://eureka.localtest.me:8761/actuator/health"
            "keycloak|http://auth.localtest.me:8080/realms/obertibussoserviciosinmobiliarios-integration"
            "frontend|http://app.localtest.me:4173"
          )
          for entry in "${services[@]}"; do
            service="${entry%%|*}"
            url="${entry##*|}"
            echo "Waiting for $service at $url"
            for i in {1..30}; do
              printf '  ↳ attempt %2d/30 … ' "$i"
              if curl -sf "$url" > /dev/null; then
                echo "success"
                echo "$service ready"
                break
              fi
              echo "not ready yet"
              if [ "$i" -eq 30 ]; then
                echo "::error::$service did not become ready in time"
                docker compose -f $COMPOSE_FILE logs "$service" || true
                exit 1
              fi
              sleep 10
            done
          done

      - name: Add 1-minute additional wait
        run: sleep 60

      - name: Seed Keycloak test user
        run: |
          docker compose -f $COMPOSE_FILE exec -T keycloak /opt/keycloak/bin/kcadm.sh config credentials --server http://auth.localtest.me:8080 --realm master --user admin --password admin
          USER_ID=$(docker compose -f $COMPOSE_FILE exec -T keycloak /opt/keycloak/bin/kcadm.sh get users -r obertibussoserviciosinmobiliarios-integration -q username=user | grep -o '\"id\" : \"[^\"]*' | head -n1 | sed -e 's/\"id\" : \"//')
          docker compose -f $COMPOSE_FILE exec -T keycloak /opt/keycloak/bin/kcadm.sh set-password -r obertibussoserviciosinmobiliarios-integration --username user --new-password Usuario1.
          docker compose -f $COMPOSE_FILE exec -T keycloak /opt/keycloak/bin/kcadm.sh update users/$USER_ID -r obertibussoserviciosinmobiliarios-integration -s 'requiredActions=[]'
          docker compose -f $COMPOSE_FILE exec -T keycloak /opt/keycloak/bin/kcadm.sh update users/$USER_ID -r obertibussoserviciosinmobiliarios-integration -s emailVerified=true
          docker compose -f $COMPOSE_FILE exec -T keycloak /opt/keycloak/bin/kcadm.sh update users/$USER_ID -r obertibussoserviciosinmobiliarios-integration -s 'attributes.phoneNumber=["+5491100000001"]'
          docker compose -f $COMPOSE_FILE exec -T keycloak /opt/keycloak/bin/kcadm.sh update users/$USER_ID -r obertibussoserviciosinmobiliarios-integration -s 'attributes.phone=["+5491100000001"]'
          docker compose -f $COMPOSE_FILE exec -T keycloak /opt/keycloak/bin/kcadm.sh add-roles -r obertibussoserviciosinmobiliarios-integration --uusername user --cclientid springboot-keycloak-client --rolename user
          ADMIN_ID=$(docker compose -f $COMPOSE_FILE exec -T keycloak /opt/keycloak/bin/kcadm.sh get users -r obertibussoserviciosinmobiliarios-integration -q username=admin | grep -o '\"id\" : \"[^\"]*' | head -n1 | sed -e 's/\"id\" : \"//')
          docker compose -f $COMPOSE_FILE exec -T keycloak /opt/keycloak/bin/kcadm.sh update users/$ADMIN_ID -r obertibussoserviciosinmobiliarios-integration -s 'requiredActions=[]'
          docker compose -f $COMPOSE_FILE exec -T keycloak /opt/keycloak/bin/kcadm.sh update users/$ADMIN_ID -r obertibussoserviciosinmobiliarios-integration -s emailVerified=true
          docker compose -f $COMPOSE_FILE exec -T keycloak /opt/keycloak/bin/kcadm.sh update users/$ADMIN_ID -r obertibussoserviciosinmobiliarios-integration -s 'attributes.phoneNumber=["+5491100000002"]'
          docker compose -f $COMPOSE_FILE exec -T keycloak /opt/keycloak/bin/kcadm.sh update users/$ADMIN_ID -r obertibussoserviciosinmobiliarios-integration -s 'attributes.phone=["+5491100000002"]'
          docker compose -f $COMPOSE_FILE exec -T keycloak /opt/keycloak/bin/kcadm.sh add-roles -r obertibussoserviciosinmobiliarios-integration --uusername admin --cclientid springboot-keycloak-client --rolename admin
          TENANT_ID=$(docker compose -f $COMPOSE_FILE exec -T keycloak /opt/keycloak/bin/kcadm.sh get users -r obertibussoserviciosinmobiliarios-integration -q username=tenant | grep -o '\"id\" : \"[^\"]*' | head -n1 | sed -e 's/\"id\" : \"//')
          docker compose -f $COMPOSE_FILE exec -T keycloak /opt/keycloak/bin/kcadm.sh set-password -r obertibussoserviciosinmobiliarios-integration --username tenant --new-password Inquilino1.
          docker compose -f $COMPOSE_FILE exec -T keycloak /opt/keycloak/bin/kcadm.sh update users/$TENANT_ID -r obertibussoserviciosinmobiliarios-integration -s 'requiredActions=[]'
          docker compose -f $COMPOSE_FILE exec -T keycloak /opt/keycloak/bin/kcadm.sh update users/$TENANT_ID -r obertibussoserviciosinmobiliarios-integration -s emailVerified=true
          docker compose -f $COMPOSE_FILE exec -T keycloak /opt/keycloak/bin/kcadm.sh update users/$TENANT_ID -r obertibussoserviciosinmobiliarios-integration -s 'attributes.phoneNumber=["+5491100000003"]'
          docker compose -f $COMPOSE_FILE exec -T keycloak /opt/keycloak/bin/kcadm.sh update users/$TENANT_ID -r obertibussoserviciosinmobiliarios-integration -s 'attributes.phone=["+5491100000003"]'
          docker compose -f $COMPOSE_FILE exec -T keycloak /opt/keycloak/bin/kcadm.sh add-roles -r obertibussoserviciosinmobiliarios-integration --uusername tenant --cclientid springboot-keycloak-client --rolename user
          docker compose -f $COMPOSE_FILE exec -T keycloak /opt/keycloak/bin/kcadm.sh add-roles -r obertibussoserviciosinmobiliarios-integration --uusername tenant --cclientid springboot-keycloak-client --rolename tenant
          docker compose -f $COMPOSE_FILE exec -T keycloak /opt/keycloak/bin/kcadm.sh update realms/obertibussoserviciosinmobiliarios-integration -s attributes.frontendUrl=http://auth.localtest.me:8080
          docker compose -f $COMPOSE_FILE exec -T keycloak bash -lc 'cat <<"EOF" >/tmp/gateway-client.json
          {
            "rootUrl": "http://api.localtest.me:8090",
            "redirectUris": [
              "http://app.localtest.me:4173/*",
              "https://oauth.pstmn.io/v1/browser-callback",
              "http://api.localtest.me:8090/login/oauth2/code/keycloak"
            ],
            "webOrigins": [
              "http://app.localtest.me:4173"
            ],
            "frontchannelLogout": true,
            "directAccessGrantsEnabled": true,
            "attributes": {
              "realm_client": "false",
              "oidc.ciba.grant.enabled": "false",
              "client.secret.creation.time": "1746664664",
              "backchannel.logout.session.required": "false",
              "standard.token.exchange.enabled": "false",
              "frontchannel.logout.session.required": "false",
              "oauth2.device.authorization.grant.enabled": "false",
              "display.on.consent.screen": "false",
              "use.jwks.url": "false",
              "backchannel.logout.revoke.offline.tokens": "false",
              "post.logout.redirect.uris": "http://app.localtest.me:4173/*",
              "homeURL": "http://app.localtest.me:4173"
            }
          }
          EOF'
          docker compose -f $COMPOSE_FILE exec -T keycloak /opt/keycloak/bin/kcadm.sh update clients/9689a5de-feda-4483-ae30-ac65599cc1eb -r obertibussoserviciosinmobiliarios-integration -f /tmp/gateway-client.json
          docker compose -f $COMPOSE_FILE exec -T keycloak /opt/keycloak/bin/kcadm.sh update realms/master -s sslRequired=NONE
          docker compose -f $COMPOSE_FILE exec -T keycloak /opt/keycloak/bin/kcadm.sh update realms/obertibussoserviciosinmobiliarios-integration -s sslRequired=none

      - name: Run Cypress suite
        working-directory: frontend
        env:
          CYPRESS_BASE_URL: ${{ env.CYPRESS_BASE_URL }}
          CYPRESS_KEYCLOAK_URL: ${{ env.CYPRESS_KEYCLOAK_URL }}
          CYPRESS_GATEWAY_URL: ${{ env.CYPRESS_GATEWAY_URL }}
          CYPRESS_API_URL: ${{ env.CYPRESS_API_URL }}
        run: npx cypress run --config baseUrl=$CYPRESS_BASE_URL,chromeWebSecurity=false

      - name: Collect compose logs
        if: failure()
        run: docker compose -f $COMPOSE_FILE logs

      - name: Tear down stack
        if: always()
        run: docker compose -f $COMPOSE_FILE down -v

      - name: Unmap integration domains
        if: always()
        run: |
          for host in auth.localtest.me api.localtest.me app.localtest.me eureka.localtest.me properties.localtest.me users.localtest.me ml.localtest.me; do
            sudo sed -i "/$host/d" /etc/hosts
          done
