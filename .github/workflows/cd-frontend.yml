name: CD - Frontend

on:
  workflow_dispatch:
  workflow_call:

env:
  # Azure
  AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}

  # Properties-specific
  SWA_LOCATION: ${{ secrets.SWA_LOCATION }}
  SWA_NAME_DEV: ${{ secrets.SWA_NAME_DEV }}
  SWA_NAME_PROD: ${{ secrets.SWA_NAME_PROD }}
  URL_FRONTEND_DEV: ${{ secrets.URL_FRONTEND_DEV }}
  URL_FRONTEND_PROD: ${{ secrets.URL_FRONTEND_PROD }}

  GATEWAY_HOSTNAME_DEV: ${{ secrets.APP_GATEWAY_DEV }}.azurewebsites.net
  GATEWAY_HOSTNAME_PROD: ${{ secrets.GATEWAY_HOSTNAME_PROD }}

jobs:
  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    environment: development

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ env.AZURE_CREDENTIALS }}

      - name: Ensure Static Web App Exists
        run: |
          if ! az staticwebapp show -g "$AZURE_RESOURCE_GROUP" -n "$SWA_NAME_DEV" &>/dev/null;
          then
            echo "üöÄ Creating $SWA_NAME_DEV..."
            az staticwebapp create \
              -g "$AZURE_RESOURCE_GROUP" \
              -n "${{ env.SWA_NAME_DEV }}" \
              --location "$SWA_LOCATION" \
              --app-location frontend \
              --output-location frontend/dist \
              --sku Free
          else
            echo "‚úèÔ∏è $SWA_NAME_DEV already exists."
          fi

      - name: Insert DEV URLs
        shell: bash
        env:
          BASE_URL: ${{ env.URL_FRONTEND_DEV }}
          GATEWAY_URL: https://${{ env.GATEWAY_HOSTNAME_DEV }}
          API_URL: https://${{ env.GATEWAY_HOSTNAME_DEV }}/api
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
        run: |
          echo "BASE_URL=$BASE_URL"
          GATEWAY_ESCAPED=${GATEWAY_URL//\/\\/}
          API_ESCAPED=${API_URL//\/\\/}
          BASE_ESCAPED=${BASE_URL//\/\\/}
          GOOGLE_SCAPED=${GOOGLE_API_KEY//\\/}

          find frontend/dist -type f -name '*.js' -exec sed -i "s#__GATEWAY_URL_PLACEHOLDER__#$GATEWAY_ESCAPED#g" {} \;
          find frontend/dist -type f -name '*.js' -exec sed -i "s#__API_URL_PLACEHOLDER__#$API_ESCAPED#g" {} \;
          find frontend/dist -type f -name '*.js' -exec sed -i "s#__BASE_URL_PLACEHOLDER__#$BASE_ESCAPED#g" {} \;
          find frontend/dist -type f -name '*.js' -exec sed -i "s#__GOOGLE_MAPS_API_KEY_PLACEHOLDER__#$GOOGLE_SCAPED#g" {} \;

      - name: Install SWA CLI
        run: npm install -g @azure/static-web-apps-cli@latest

      - name: Deploy to SWA
        run: |
          DEPLOY_TOKEN=$(az staticwebapp secrets list \
            --name "$SWA_NAME_DEV" \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --query properties.apiKey -o tsv)
          swa deploy frontend/dist \
            --app-name "$SWA_NAME_DEV" \
            --env production \
            --deployment-token "$DEPLOY_TOKEN"

  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [deploy-dev]
    environment: production

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ env.AZURE_CREDENTIALS }}

      - name: Ensure Static Web App Exists
        run: |
          if ! az staticwebapp show -g "$AZURE_RESOURCE_GROUP" -n "$SWA_NAME_PROD" &>/dev/null;
          then
            echo "üöÄ Creating $SWA_NAME_PROD..."
            az staticwebapp create \
              -g "$AZURE_RESOURCE_GROUP" \
              -n "${{ env.SWA_NAME_PROD }}" \
              --location "$SWA_LOCATION" \
              --app-location frontend \
              --output-location frontend/dist \
              --sku Free
          else
            echo "‚úèÔ∏è $SWA_NAME_PROD already exists."
          fi

      - name: Insert PROD URLs
        shell: bash
        env:
          BASE_URL: ${{ env.URL_FRONTEND_PROD }}
          GATEWAY_URL: https://${{ env.GATEWAY_HOSTNAME_PROD }}
          API_URL: https://${{ env.GATEWAY_HOSTNAME_PROD }}/api
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
        run: |
          echo "BASE_URL=$BASE_URL"
          GATEWAY_ESCAPED=${GATEWAY_URL//\/\\/}
          API_ESCAPED=${API_URL//\/\\/}
          BASE_ESCAPED=${BASE_URL//\/\\/}
          GOOGLE_SCAPED=${GOOGLE_API_KEY//\\/}

          find frontend/dist -type f -name '*.js' -exec sed -i "s#__GATEWAY_URL_PLACEHOLDER__#$GATEWAY_ESCAPED#g" {} \;
          find frontend/dist -type f -name '*.js' -exec sed -i "s#__API_URL_PLACEHOLDER__#$API_ESCAPED#g" {} \;
          find frontend/dist -type f -name '*.js' -exec sed -i "s#__BASE_URL_PLACEHOLDER__#$BASE_ESCAPED#g" {} \;
          find frontend/dist -type f -name '*.js' -exec sed -i "s#__GOOGLE_MAPS_API_KEY_PLACEHOLDER__#$GOOGLE_SCAPED#g" {} \;

      - name: Install SWA CLI
        run: npm install -g @azure/static-web-apps-cli@latest

      - name: Deploy to SWA
        run: |
          DEPLOY_TOKEN=$(az staticwebapp secrets list \
            --name "$SWA_NAME_PROD" \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --query properties.apiKey -o tsv)
          swa deploy frontend/dist \
            --app-name "$SWA_NAME_PROD" \
            --env production \
            --deployment-token "$DEPLOY_TOKEN"
